<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocal Hub Contest</title>
    <style>
        :root { --header-bg: #000; --button-primary-bg: #ffc107; --button-primary-text: #000; --button-admin-bg: #dc3545; --secondary-color: #6c757d; --light-color: #f8f9fa; --success-color: #28a745; --danger-color: #dc3545; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; background-color: var(--light-color); display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 1rem 0; }
        .app-container { width: 100%; max-width: 480px; background-color: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); overflow: hidden; }
        header { background-color: var(--header-bg); color: white; text-align: center; padding: 0.5rem; }
        header img { height: 60px; width: auto; display: block; margin: 0 auto; }
        main { padding: 1.5rem; }
        .screen { display: none; }
        .screen.active { display: block; }
        h2, h3 { margin-top: 0; text-align: center; }
        .form-group { margin-bottom: 1rem; }
        .contestant-list { list-style-type: none; padding: 0; }
        .contestant-item { display: flex; align-items: center; background-color: #fdfdfd; border: 1px solid #ddd; border-radius: 8px; padding: 0.75rem 1rem; margin-bottom: 0.5rem; }
        .contestant-item input[type="checkbox"] { width: 1.5em; height: 1.5em; margin-right: 1rem; }
        .contestant-item label, .admin-contestant-list-item span { font-weight: 500; flex-grow: 1; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        input[type="text"], input[type="email"] { width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn { display: block; width: 100%; padding: 0.75rem; border: none; border-radius: 4px; font-size: 1rem; font-weight: bold; cursor: pointer; text-align: center; text-decoration: none; margin-top: 1rem; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-primary { background-color: var(--button-primary-bg); color: var(--button-primary-text); }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-admin { background-color: var(--button-admin-bg); color: white; }
        #login-message, #voting-status { text-align: center; padding: 10px; border-radius: 5px; font-weight: bold; margin-bottom: 1rem; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="loading-spinner" style="display: none; position: fixed; top: 45%; font-weight: bold;">Caricamento...</div>

    <div class="app-container">
        <header id="app-header">
            <img src="https://raw.githubusercontent.com/Scream1986/festival-voto/main/Logo.png" alt="Vocal Hub Logo">
        </header>
        <main>
            <div id="login-screen" class="screen">
                <h2>Benvenuto al Contest</h2>
                <p style="text-align: center; color: #666;">Inserisci la tua email per ricevere un link di accesso e votare.</p>
                <div id="login-message"></div>
                <div class="form-group">
                    <label for="user-email">La tua Email</label>
                    <input type="email" id="user-email" placeholder="mario.rossi@email.com" autocomplete="off">
                </div>
                <button id="login-btn" class="btn btn-primary">Ricevi Link per Votare</button>
            </div>

            <div id="main-screen" class="screen">
                <div id="admin-view" style="display: none;">
                    <h2>Pannello Amministratore</h2>
                    <p>Loggato come <strong id="user-email-display-admin"></strong></p>
                    <button id="logout-btn-admin" class="btn btn-admin">Esci</button>
                </div>

                <div id="public-view" style="display: none;">
                    <h2>Area Votazione</h2>
                    <p>Loggato come <strong id="user-email-display-public"></strong></p>
                    <div id="voting-status"></div>
                    <div id="public-voting-area">
                        <p>Puoi esprimere fino a <strong>3 preferenze</strong>.</p>
                        <div id="contestants-container"></div>
                        <button id="vote-btn" class="btn btn-primary">Vota</button>
                    </div>
                    <button id="logout-btn-public" class="btn btn-secondary">Esci</button>
                </div>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // ---------- 1. CONFIGURAZIONE: INSERISCI I TUOI DATI QUI ----------
    
    const SUPABASE_URL = 'INCOLLA_QUI_IL_TUO_URL_SUPABASE';
    const SUPABASE_ANON_KEY = 'INCOLLA_QUI_LA_TUA_ANON_KEY_SUPABASE';
    const ADMIN_EMAIL = 'INSERISCI_QUI_LA_TUA_EMAIL_DA_AMMINISTRATORE'; // IMPORTANTE!

    // ---------- FINE CONFIGURAZIONE ----------


    // --- Inizializzazione di Supabase ---
    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- Elementi del DOM ---
    const loadingSpinner = document.getElementById('loading-spinner');
    const screens = {
        login: document.getElementById('login-screen'),
        main: document.getElementById('main-screen')
    };
    const adminView = document.getElementById('admin-view');
    const publicView = document.getElementById('public-view');
    const loginBtn = document.getElementById('login-btn');
    const logoutButtons = document.querySelectorAll('#logout-btn-admin, #logout-btn-public');
    const voteBtn = document.getElementById('vote-btn');
    const loginMessage = document.getElementById('login-message');
    
    // --- Funzioni UI ---
    const showLoading = (isLoading) => {
        loadingSpinner.style.display = isLoading ? 'block' : 'none';
    };
    
    const navigateTo = (screenId) => {
        Object.values(screens).forEach(s => s.classList.remove('active'));
        if (screens[screenId]) screens[screenId].classList.add('active');
    };

    const showLoginMessage = (message, isError = false) => {
        loginMessage.textContent = message;
        loginMessage.style.color = isError ? 'var(--danger-color)' : 'var(--success-color)';
    };

    // --- Funzione Principale di Login ---
    const handleLogin = async () => {
        const email = document.getElementById('user-email').value;
        if (!email) {
            showLoginMessage('Per favore, inserisci un\'email.', true);
            return;
        }

        showLoading(true);
        loginBtn.disabled = true;

        try {
            const { error } = await supabase.functions.invoke('magic-link', {
                body: { email }
            });

            if (error) throw error;
            
            showLoginMessage('Link di accesso inviato! Controlla la tua casella di posta (anche lo spam).');
        } catch (error) {
            console.error("Errore durante la chiamata alla function:", error);
            showLoginMessage('Si è verificato un errore. Riprova.', true);
        } finally {
            showLoading(false);
            loginBtn.disabled = false;
        }
    };

    loginBtn.addEventListener('click', handleLogin);

    // --- Gestione Logout ---
    logoutButtons.forEach(btn => {
        btn.addEventListener('click', async () => {
            showLoading(true);
            await supabase.auth.signOut();
            showLoading(false);
            // onAuthStateChange gestirà il cambio di schermata
        });
    });

    // --- Gestione della Sessione Utente (La parte più importante) ---
    supabase.auth.onAuthStateChange(async (event, session) => {
        showLoading(true);
        if (session && session.user) {
            // L'utente è loggato
            const user = session.user;
            
            // Controlla se è un admin
            if (user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                document.getElementById('user-email-display-admin').textContent = user.email;
                adminView.style.display = 'block';
                publicView.style.display = 'none';
            } else {
                // È un utente del pubblico
                document.getElementById('user-email-display-public').textContent = user.email;
                adminView.style.display = 'none';
                publicView.style.display = 'block';
                // Qui andrà la logica per mostrare la votazione...
            }
            navigateTo('main');
        } else {
            // L'utente non è loggato
            navigateTo('login');
        }
        showLoading(false);
    });
});
</script>
</body>
</html>